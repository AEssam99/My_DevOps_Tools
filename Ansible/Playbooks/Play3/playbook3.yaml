---
#Lab 4 â€“ Users & SSH Security Hardening
#1- Create a new admin user on all servers
#2- Allow SSH login using key only (no password)
#3- Disable direct root SSH login
#4- Restart SSH safely without locking yourself out
#

- name: Users & SSH Security Hardening
  hosts: web

  tasks:
  - name: Create a new admin user on all servers
    ansible.builtin.user:
      name: devops
      shell: /bin/bash
      group: wheel
      append: true
      create_home: true


  - name: Set authorized key taken from file
    ansible.posix.authorized_key:
      user: devops
      state: present
      key: "{{ lookup('file', '/home/aessam/.ssh/id_rsa.pub') }}"


  - name: Disable direct root SSH login
    ansible.builtin.lineinfile:
      path: /etc/ssh/sshd_config
      regexp: ^(#\s*)?PermitRootLogin
      line: PermitRootLogin no
      validate: '/usr/sbin/sshd -t -f %s'
    notify: Restart_SSH


  - name: Disable Password Auth
    ansible.builtin.lineinfile:
      path: /etc/ssh/sshd_config
      regexp: ^(#\s*)?PasswordAuthentication
      line: PasswordAuthentication no
      validate: '/usr/sbin/sshd -t -f %s'
    notify: Restart_SSH

  handlers:
    - name: Restart_SSH
      service:
        name: sshd
        state: restarted



 

